<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Period Timer</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --accent:#0b1226; --muted:#6b7280;
    --radius:10px; --shadow:0 6px 18px rgba(12,15,30,0.06);
    --max-width:980px; --gap:8px; --font-system:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  }
  html,body{height:100%}
  body{font-family:var(--font-system); margin:0; background:var(--bg); color:#111; padding:16px; -webkit-font-smoothing:antialiased}
  .container{max-width:var(--max-width);margin:0 auto}
  header h1{font-size:18px;margin:0 0 8px}
  .muted{color:var(--muted);font-size:13px}
  .info{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid #eef2ff}
  .controls{display:flex;gap:var(--gap);flex-wrap:wrap;margin-bottom:12px;align-items:center}
  button{padding:8px 12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font:inherit}
  button:focus{outline:3px solid rgba(11,18,38,0.12); outline-offset:2px}
  .small-btn{padding:6px 8px;font-size:13px;border-radius:6px}
  .editor{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:12px}
  label{display:block;font-size:13px;margin-top:8px}
  input[type="text"], input[type="time"], input[type="file"], select{padding:8px;border-radius:8px;border:1px solid #d1d5db;width:100%;box-sizing:border-box;font:inherit}
  .row{display:flex;gap:var(--gap);align-items:center}
  .small{width:180px;min-width:120px}
  .days{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
  .day{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:6px;border:1px solid #eee;background:#fafafa;font-size:13px;cursor:pointer}
  .day input{margin:0}
  .schedule-summary{background:#fff;padding:12px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:12px}
  .schedule-day{margin-bottom:8px}
  .schedule-entry{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:6px;background:#fafafa;margin-top:6px;border:1px solid #efefef}
  .tag{background:#eef2ff;padding:4px 6px;border-radius:6px;font-size:12px;margin-left:6px}
  .popup{position:fixed;bottom:12px;right:12px;background:var(--accent);color:white;padding:12px 14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.35);width:300px;font-size:14px;opacity:0.98;cursor:pointer;display:flex;flex-direction:column;gap:6px}
  .popup h3{margin:0 0 0;font-size:15px;line-height:1}
  .popup .line{font-size:13px;margin-top:2px}
  .footer{margin-top:10px;font-size:13px;color:#333}
  .hidden{display:none !important}
  .toast-wrap{position:fixed;left:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
  .toast{background:#fff;padding:10px 12px;border-radius:8px;box-shadow:var(--shadow);border:1px solid #e5e7eb;font-size:14px}
  @media(max-width:640px){
    .popup{width:92%;left:4%;right:4%}
    .row{flex-direction:column}
    .small{width:100%}
  }
  @media (prefers-reduced-motion: reduce){ *{transition:none !important} }
  .controls .status{font-weight:600;margin-left:6px}
</style>
</head>
<body>
<main class="container" id="main">
  <header>
    <h1>Period Timer</h1>
    <p class="muted">Keep this tab open for the Period Timer and notifications.</p>
  </header>

  <section class="info" aria-live="polite">
    <strong>How to use</strong>
    <ol style="margin:6px 0 0 18px;padding:0">
      <li>Click <strong>View week</strong> to show the schedule for Week A or Week B.</li>
      <li>Click <strong>Edit Schedule</strong> to open the editor and add or change periods for the selected week(s).</li>
      <li>Click <strong>Floating Mode</strong> so you have access to the timer when you switch tabs or go to different apps (this should always be on).</li>
      <li>Enable <strong>Notifications</strong> to receive reminders and alerts.</li>
      <li>Select <strong>Active Week</strong> to week A or week B (this will tell it which week to display on the screen).</li>
    </ol>
    <hr style="margin:8px 0">
    <strong>Export / Import</strong>
    <p class="muted" style="margin:4px 0 6px">
      • Downloads your timetable in a special format (read below).<br>
      • Upload your downloaded timetable here to load it in. 
    </p>
  </section>

  <!-- Controls: Active week toggle + View selector + primary buttons -->
  <section class="controls" role="toolbar" aria-label="Schedule controls">
    <div style="display:flex;gap:8px;align-items:center">
      <div class="muted">Active week:</div>
      <button id="setActiveA" class="small-btn">Week A</button>
      <button id="setActiveB" class="small-btn">Week B</button>
      <!--  <div class="status muted" id="activeWeekLabel"></div> -->
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="muted">View week:</div>
      <select id="viewWeekSelect" aria-label="Select week to view">
        <option value="A">Week A</option>
        <option value="B">Week B</option>
      </select>
    </div>

    <div style="flex:1"></div>

    <button id="openEditorBtn" title="Open schedule editor">Edit Schedule</button>
    <button id="floatingBtn" title="Start floating PiP mode">Floating Mode</button>
    <button id="exportBtn" title="Download schedule as JSON">Export JSON</button>
    <button id="importBtn" title="Load schedule from JSON">Import JSON</button>
    <input id="importFile" type="file" accept="application/json" class="hidden" />
    <button id="clearBtn" title="Clear schedule">Clear Schedule</button>
    <button id="notifyBtn" title="Enable or disable browser notifications">Enable Notifications</button>
  </section>

  <!-- Visible schedule summary (shows selected view week) -->
  <section class="schedule-summary" aria-label="Schedule summary">
    <strong>Schedule summary — <span id="viewWeekLabel">Week A</span></strong>
    <div id="scheduleSummary" style="margin-top:8px"></div>
    <div class="muted" style="margin-top:8px">Click Edit to change an entry. Use the editor to choose which week(s) the entry belongs to.</div>
  </section>

  <!-- Editor -->
  <section id="editor" class="editor hidden" role="dialog" aria-modal="false" aria-label="Schedule editor">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Schedule Editor</strong>
      <div><button id="closeEditorBtn" aria-label="Close editor">Close</button></div>
    </div>

    <label for="className">Class name</label>
    <input id="className" type="text" placeholder="e.g. Math" />

    <div class="row" style="margin-top:8px">
      <div class="small">
        <label for="startTime">Start time</label>
        <input id="startTime" type="time" />
      </div>
      <div class="small">
        <label for="endTime">End time</label>
        <input id="endTime" type="time" />
      </div>
    </div>

    <label style="margin-top:8px">Days</label>
    <div class="days" id="days" role="group" aria-label="Choose days">
      <label class="day"><input type="checkbox" value="0" /> Mon</label>
      <label class="day"><input type="checkbox" value="1" /> Tue</label>
      <label class="day"><input type="checkbox" value="2" /> Wed</label>
      <label class="day"><input type="checkbox" value="3" /> Thu</label>
      <label class="day"><input type="checkbox" value="4" /> Fri</label>
      <label class="day"><input type="checkbox" value="5" /> Sat</label>
      <label class="day"><input type="checkbox" value="6" /> Sun</label>
    </div>

    <label style="margin-top:8px">Weeks</label>
    <div class="days" id="weeks">
      <label class="day"><input type="checkbox" value="A" /> Week A</label>
      <label class="day"><input type="checkbox" value="B" /> Week B</label>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <button id="addBtn">Add / Save Entry</button>
      <div class="muted" id="editorHint" aria-live="polite">Tip: press Ctrl/Cmd+E to toggle editor or click an Edit button.</div>
    </div>

    <div class="schedule-list" id="scheduleList" aria-live="polite" style="margin-top:12px"></div>
  </section>

  <div class="footer">Tip: Pin the tab and keep the browser open. PiP & notifications depend on your browser.</div>
</main>

<!-- Hidden PiP elements ORIGINAL 360 160-->
<video id="pipVideo" muted playsinline style="display:none" aria-hidden="true"></video>
<canvas id="pipCanvas" width="360" height="160" style="display:none" aria-hidden="true"></canvas>

<!-- popup -->
<div class="popup" id="popup" role="button" aria-pressed="false" tabindex="0" title="Click to open editor">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 id="popupTitle">No active period</h3>
    <div class="muted" id="popupSub">—</div>
  </div>
  <div class="line" id="popupTime">Next: —</div>
</div>

<!-- template & toasts -->
<template id="entryTemplate">
  <div class="entry" role="listitem">
    <div class="left"><strong class="entry-name"></strong> <span class="tag entry-time"></span></div>
    <div class="right">
      <button class="edit">Edit</button>
      <button class="delete">Delete</button>
    </div>
  </div>
</template>

<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<script>
/* ============================
   New schema:
   schedule = {
     weeks: { A: [ [],[],...7 ], B: [ [],...,7 ] }
   }
   Migration: if older single-week format exists, copy into both A & B.
   Active week stored separately in localStorage key ACTIVE_WEEK_KEY.
*/
const STORAGE_KEYS = ["period_timer_schedule_v2", "period_timer_schedule_v1", "period_timer_schedule"];
const ACTIVE_WEEK_KEY = "period_timer_active_week"; // "A" or "B"

function defaultSchedule(){ return { weeks: { A: [[],[],[],[],[],[],[]], B: [[],[],[],[],[],[],[]] } }; }

function isOldSingleWeek(obj){
  return obj && obj.days && Array.isArray(obj.days) && obj.days.length === 7;
}
function isNewTwoWeek(obj){
  return obj && obj.weeks && obj.weeks.A && obj.weeks.B && Array.isArray(obj.weeks.A) && obj.weeks.A.length===7 && Array.isArray(obj.weeks.B) && obj.weeks.B.length===7;
}
function validateSchedule(obj){
  if(isNewTwoWeek(obj)){
    for(const w of ["A","B"]){
      for(const d of obj.weeks[w]) if(!Array.isArray(d)) return false;
      for(const d of obj.weeks[w]) for(const e of d) if(!e || typeof e.name!=="string" || typeof e.start!=="string" || typeof e.end!=="string") return false;
    }
    return true;
  }
  if(isOldSingleWeek(obj)){
    for(const d of obj.days) if(!Array.isArray(d)) return false;
    for(const d of obj.days) for(const e of d) if(!e || typeof e.name!=="string" || typeof e.start!=="string" || typeof e.end!=="string") return false;
    return true;
  }
  return false;
}

function loadSchedule(){
  try{
    for(const key of STORAGE_KEYS){
      const raw = localStorage.getItem(key);
      if(!raw) continue;
      try{
        const parsed = JSON.parse(raw);
        if(isNewTwoWeek(parsed) && validateSchedule(parsed)) return parsed;
        if(isOldSingleWeek(parsed) && validateSchedule(parsed)){
          // migrate: copy single-week days into both A & B
          const clone = JSON.parse(JSON.stringify(parsed.days));
          return { weeks: { A: clone, B: clone.map(day=>day.map(e=>({...e}))) } };
        }
      } catch(e){ continue; }
    }
    return defaultSchedule();
  } catch(e){
    console.warn("loadSchedule err", e);
    return defaultSchedule();
  }
}

function saveSchedule(s){
  try{ localStorage.setItem(STORAGE_KEYS[0], JSON.stringify(s)); } catch(e){ showToast("Unable to save schedule"); }
}

/* Active week helpers */
function getActiveWeek(){ return localStorage.getItem(ACTIVE_WEEK_KEY) || "A"; }
function setActiveWeek(w){
  if(w!=="A" && w!=="B") return;
  localStorage.setItem(ACTIVE_WEEK_KEY, w);
  document.getElementById("activeWeekLabel").innerText = " " + w;
  // also update popup/PiP/notifications
  renderScheduleSummary();
  scheduleNotificationsForNextEvents();
  updatePopup();
}

/* Model & helpers */
let schedule = loadSchedule();
const dayNames = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

/* UI refs */
const openEditorBtn = document.getElementById("openEditorBtn");
const editor = document.getElementById("editor");
const addBtn = document.getElementById("addBtn");
const classNameInput = document.getElementById("className");
const startTimeInput = document.getElementById("startTime");
const endTimeInput = document.getElementById("endTime");
const daysEl = document.getElementById("days");
const weeksEl = document.getElementById("weeks");
const scheduleList = document.getElementById("scheduleList");
const scheduleSummary = document.getElementById("scheduleSummary");
const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupTime = document.getElementById("popupTime");
const popupSub = document.getElementById("popupSub");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");
const clearBtn = document.getElementById("clearBtn");
const notifyBtn = document.getElementById("notifyBtn");
const floatingBtn = document.getElementById("floatingBtn");
const entryTemplate = document.getElementById("entryTemplate");
const viewWeekSelect = document.getElementById("viewWeekSelect");
const viewWeekLabel = document.getElementById("viewWeekLabel");
const activeA = document.getElementById("setActiveA");
const activeB = document.getElementById("setActiveB");
const activeWeekLabel = document.getElementById("activeWeekLabel");

let editingEntry = null; // {week:"A"|"B", day, index}
let notifEnabled = false;
let scheduledNotifs = [];

/* helpers */
function showToast(text, ttl=2500){
  const wrap = document.getElementById("toastWrap");
  const node = document.createElement("div");
  node.className = "toast";
  node.textContent = text;
  wrap.appendChild(node);
  setTimeout(()=>{ node.remove(); }, ttl);
}
function timeToDateToday(hm){
  const [h,m] = hm.split(":").map(n=>parseInt(n,10)||0);
  const d = new Date(); d.setHours(h,m,0,0); return d;
}
function msToMinSec(ms){ if(ms<=0) return "0:00"; const s=Math.floor(ms/1000); const m=Math.floor(s/60); return `${m}:${(s%60).toString().padStart(2,"0")}`; }

/* keyboard shortcuts */
document.addEventListener("keydown", (e)=>{
  if((e.key==="e"||e.key==="E") && (e.ctrlKey||e.metaKey)){ e.preventDefault(); toggleEditor(); }
  if(e.key==="Escape"){ if(!editor.classList.contains("hidden")) closeEditor(); }
});

/* wire editor open/close */
if(openEditorBtn) openEditorBtn.addEventListener("click", openEditor);
const closeEditorBtn = document.getElementById("closeEditorBtn");
if(closeEditorBtn) closeEditorBtn.addEventListener("click", closeEditor);

function toggleEditor(){ if(editor.classList.contains("hidden")) openEditor(); else closeEditor(); }
function openEditor(){ editor.classList.remove("hidden"); renderScheduleList(); classNameInput.focus(); }
function closeEditor(){ editor.classList.add("hidden"); editingEntry=null; clearEditor(); }

function clearEditor(){
  classNameInput.value=""; startTimeInput.value=""; endTimeInput.value="";
  daysEl.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
  weeksEl.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=true); // default both
  editingEntry=null; addBtn.innerText="Add / Save Entry";
}

/* Get currently selected view week (for summary/editor list) */
function getViewWeek(){ return viewWeekSelect.value || getActiveWeek(); }

/* Render editor list (for selected view week) */
function renderScheduleList(){
  const viewWeek = getViewWeek();
  scheduleList.innerHTML = "";
  const weekArr = schedule.weeks[viewWeek];
  for(let d=0; d<7; d++){
    const list = weekArr[d];
    const block = document.createElement("div"); block.style.marginBottom="8px";
    const title = document.createElement("div"); title.style.fontWeight="600"; title.style.marginTop="6px"; title.innerText = dayNames[d];
    block.appendChild(title);
    if(list.length===0){
      const p = document.createElement("div"); p.className="muted"; p.innerText="No entries"; block.appendChild(p);
    } else {
      list.forEach((entry, idx) => {
        const frag = entryTemplate.content.cloneNode(true);
        frag.querySelector(".entry-name").textContent = entry.name;
        frag.querySelector(".entry-time").textContent = `${entry.start}–${entry.end}`;
        frag.querySelector(".edit").addEventListener("click", ()=> openEdit(viewWeek, d, idx));
        frag.querySelector(".delete").addEventListener("click", ()=> { if(!confirm("Delete?")) return; schedule.weeks[viewWeek][d].splice(idx,1); saveSchedule(schedule); renderScheduleList(); renderScheduleSummary(); showToast("Deleted"); });
        block.appendChild(frag);
      });
    }
    scheduleList.appendChild(block);
  }
}

/* Render visible schedule summary for selected view week */
function renderScheduleSummary(){
  const viewWeek = getViewWeek();
  viewWeekLabel.innerText = `Week ${viewWeek}`;
  scheduleSummary.innerHTML = "";
  const weekArr = schedule.weeks[viewWeek];
  for(let d=0; d<7; d++){
    const list = weekArr[d];
    const dayBlock = document.createElement("div");
    dayBlock.className = "schedule-day";
    const title = document.createElement("div"); title.style.fontWeight="600"; title.innerText = dayNames[d];
    dayBlock.appendChild(title);
    if(list.length===0){
      const p = document.createElement("div"); p.className="muted"; p.innerText="No entries"; dayBlock.appendChild(p);
    } else {
      list.forEach((entry, idx)=>{
        const row = document.createElement("div"); row.className="schedule-entry";
        const left = document.createElement("div");
        left.innerHTML = `<strong>${escapeHtml(entry.name)}</strong> <span class="tag">${entry.start}–${entry.end}</span>`;
        const right = document.createElement("div");
        const editBtn = document.createElement("button"); editBtn.innerText = "Edit"; editBtn.addEventListener("click", ()=> openEdit(viewWeek, d, idx));
        const delBtn = document.createElement("button"); delBtn.innerText = "Delete"; delBtn.addEventListener("click", ()=> { if(!confirm("Delete?")) return; schedule.weeks[viewWeek][d].splice(idx,1); saveSchedule(schedule); renderScheduleList(); renderScheduleSummary(); showToast("Deleted"); });
        right.appendChild(editBtn); right.appendChild(delBtn);
        row.appendChild(left); row.appendChild(right);
        dayBlock.appendChild(row);
      });
    }
    scheduleSummary.appendChild(dayBlock);
  }
}
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, (s)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* open edit: populate editor fields, and set weeks checkboxes based on membership (A/B) */
function openEdit(week, day, index){
  const entry = schedule.weeks[week][day][index];
  classNameInput.value = entry.name;
  startTimeInput.value = entry.start;
  endTimeInput.value = entry.end;
  daysEl.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
  daysEl.querySelectorAll("input[type=checkbox]")[day].checked = true;
  // weeks checkboxes: check A/B if same entry exists (matching name/start/end) in each week/day
  const weekChecks = weeksEl.querySelectorAll("input[type=checkbox]");
  weekChecks.forEach(cb=>{
    const w = cb.value;
    const exists = schedule.weeks[w][day].some(e => e.name===entry.name && e.start===entry.start && e.end===entry.end);
    cb.checked = !!exists;
  });
  editingEntry = { week, day, index };
  addBtn.innerText = "Save Changes";
  editor.classList.remove("hidden");
  classNameInput.focus();
}

/* Add / Save entry logic (supports selecting weeks A/B) */
function addOrSave(){
  const name = classNameInput.value.trim();
  const start = startTimeInput.value;
  const end = endTimeInput.value;
  if(!name || !start || !end){ showToast("Enter name, start, end"); return; }
  const selectedDays = Array.from(daysEl.querySelectorAll("input[type=checkbox]")).filter(cb=>cb.checked).map(cb=>parseInt(cb.value,10));
  if(selectedDays.length===0){ showToast("Select at least one day"); return; }
  const selectedWeeks = Array.from(weeksEl.querySelectorAll("input[type=checkbox]")).filter(cb=>cb.checked).map(cb=>cb.value); // ["A","B"]
  if(selectedWeeks.length===0){ showToast("Select at least one week (A/B)"); return; }
  const sD = timeToDateToday(start), eD = timeToDateToday(end);
  if(eD <= sD){ showToast("End must be after start"); return; }

  if(editingEntry){
    // Update the original week/day/index
    const {week, day, index} = editingEntry;
    schedule.weeks[week][day][index] = { name, start, end };
    // For other selected weeks, add if not exists
    for(const w of selectedWeeks){
      if(w === week) continue;
      for(const d of selectedDays){
        const exists = schedule.weeks[w][d].some(e => e.name===name && e.start===start && e.end===end);
        if(!exists) schedule.weeks[w][d].push({name,start,end});
      }
    }
    showToast("Saved changes.");
  } else {
    // New entry: push to each selected week/day
    for(const w of selectedWeeks){
      for(const d of selectedDays){
        const exists = schedule.weeks[w][d].some(e => e.name===name && e.start===start && e.end===end);
        if(!exists) schedule.weeks[w][d].push({name,start,end});
      }
    }
    showToast("Added entry.");
  }

  // sort each day's entries
  for(const w of ["A","B"]){
    for(let d=0; d<7; d++){
      schedule.weeks[w][d].sort((a,b)=>{ const [ah,am]=a.start.split(":").map(Number); const [bh,bm]=b.start.split(":").map(Number); return ah*60+am - (bh*60+bm); });
    }
  }

  saveSchedule(schedule);
  clearEditor();
  renderScheduleList();
  renderScheduleSummary();
  scheduleNotificationsForNextEvents();
}
addBtn.addEventListener("click", addOrSave);

/* Export/Import — accept both formats. When exporting we output the new two-week schema. */
exportBtn.addEventListener("click", ()=>{
  try{
    const blob = new Blob([JSON.stringify(schedule, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "period-schedule-2week.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    showToast("Exported JSON");
  } catch(e){ showToast("Export failed"); }
});
importBtn.addEventListener("click", ()=> importFile.click());
importFile.addEventListener("change", (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const p = JSON.parse(r.result);
      if(isNewTwoWeek(p) && validateSchedule(p)){
        schedule = p;
      } else if(isOldSingleWeek(p) && validateSchedule(p)){
        const clone = JSON.parse(JSON.stringify(p.days));
        schedule = { weeks: { A: clone, B: clone.map(day=>day.map(e=>({ ...e }))) } };
      } else throw new Error("Invalid format");
      saveSchedule(schedule);
      renderScheduleList(); renderScheduleSummary();
      showToast("Imported schedule.");
      scheduleNotificationsForNextEvents();
    }catch(e){ showToast("Import failed: " + (e.message||e)); }
  };
  r.readAsText(f);
});

/* Clear schedule */
clearBtn.addEventListener("click", ()=>{ if(!confirm("Clear entire schedule?")) return; schedule = defaultSchedule(); saveSchedule(schedule); renderScheduleList(); renderScheduleSummary(); showToast("Cleared"); });

/* Active week UI wiring */
activeA.addEventListener("click", ()=> setActiveWeek("A"));
activeB.addEventListener("click", ()=> setActiveWeek("B"));
viewWeekSelect.addEventListener("change", ()=> { renderScheduleList(); renderScheduleSummary(); });

/* Popup compute uses the ACTIVE WEEK (what school is running) */
function computeCurrentAndNext(){
  const now = new Date();
  const activeWeek = getActiveWeek();
  const dayIdx = (now.getDay() + 6) % 7;
  const todays = schedule.weeks[activeWeek][dayIdx] || [];
  const curMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60.0;
  let current=null, next=null;
  for(let i=0;i<todays.length;i++){
    const e = todays[i];
    const [sh,sm]= e.start.split(":").map(Number);
    const [eh,em]= e.end.split(":").map(Number);
    const startMin = sh*60+sm, endMin = eh*60+em;
    if(curMin >= startMin && curMin < endMin){ current = {entry:e,startMin,endMin,index:i}; if(i+1<todays.length) next = {entry:todays[i+1], index:i+1}; break; }
    if(curMin < startMin){ next = {entry:e,index:i}; break; }
  }
  return { now, current, next };
}

function updatePopup(){
  const {now,current,next} = computeCurrentAndNext();
  if(current){
    const endDate = timeToDateToday(current.entry.end);
    const msLeft = endDate - now;
    popupTitle.innerText = `${current.entry.name} — ${msToMinSec(msLeft)}`;
    popupTime.innerText = `Ends at ${current.entry.end} (${msToMinSec(msLeft)})`;
    popupSub.innerText = next ? `Next: ${next.entry.name} at ${next.entry.start}` : `No more periods today`;
    popup.setAttribute("aria-pressed","true");
  } else if(next){
    const startDate = timeToDateToday(next.entry.start);
    const msUntil = startDate - now;
    popupTitle.innerText = `No active period`;
    popupTime.innerText = `Next: ${next.entry.name} in ${msToMinSec(msUntil)}`;
    popupSub.innerText = `Starts at ${next.entry.start}`;
    popup.setAttribute("aria-pressed","false");
  } else {
    popupTitle.innerText = "No scheduled periods today";
    popupTime.innerText = "Enjoy your free time!";
    popupSub.innerText = "";
    popup.setAttribute("aria-pressed","false");
  }
}
popup.addEventListener("click", ()=> openEditor());
popup.addEventListener("keydown", (e)=> { if(e.key==="Enter"||e.key===" ") openEditor(); });

/* Notifications (use ACTIVE week) */
function clearScheduledNotifs(){ scheduledNotifs.forEach(id=>clearTimeout(id)); scheduledNotifs = []; }
function scheduleNotificationsForNextEvents(){
  clearScheduledNotifs();
  if(!notifEnabled || !("Notification" in window)) return;
  if(Notification.permission !== "granted") return;
  const now = new Date();
  const activeWeek = getActiveWeek();
  const dayIdx = (now.getDay() + 6) % 7;
  const todays = schedule.weeks[activeWeek][dayIdx] || [];
  for(const entry of todays){
    const startDate = timeToDateToday(entry.start);
    const endDate = timeToDateToday(entry.end);
    if(startDate>now){
      const ms = startDate - now;
      scheduledNotifs.push(setTimeout(()=> new Notification("Class starting: " + entry.name, {body:`Starts at ${entry.start}`}), ms));
      const ms5 = ms - 5*60*1000; if(ms5>0) scheduledNotifs.push(setTimeout(()=> new Notification("Upcoming in 5 min: "+entry.name,{body:entry.start}), ms5));
    }
    if(endDate>now){
      const msEnd = endDate-now; const ms1Before = msEnd - 60*1000; if(ms1Before>0) scheduledNotifs.push(setTimeout(()=> new Notification("1 minute left: "+entry.name, {body: entry.end}), ms1Before));
    }
  }
}
function requestNotificationPermission(){
  if(!("Notification" in window)){ showToast("Notifications unsupported"); return; }
  Notification.requestPermission().then(p => {
    if(p==="granted"){ notifEnabled=true; notifyBtn.innerText="Notifications: ON"; scheduleNotificationsForNextEvents(); showToast("Notifications enabled"); }
    else { notifEnabled=false; notifyBtn.innerText="Enable Notifications"; clearScheduledNotifs(); showToast("Notifications blocked"); }
  });
}
notifyBtn.addEventListener("click", ()=> { if(!notifEnabled) requestNotificationPermission(); else { notifEnabled=false; notifyBtn.innerText="Enable Notifications"; clearScheduledNotifs(); showToast("Notifications disabled"); } });
window.addEventListener("focus", scheduleNotificationsForNextEvents);
document.addEventListener("visibilitychange", ()=> { if(document.visibilityState==="visible") scheduleNotificationsForNextEvents(); });

/* PiP (uses active week for displayed times) */
const pipCanvas = document.getElementById("pipCanvas");
const pipVideo = document.getElementById("pipVideo");
const ctx = pipCanvas.getContext("2d");
let pipStreamAttached=false, pipDrawingInterval=null;




function drawPiPTimer(){
  ctx.clearRect(0,0,pipCanvas.width,pipCanvas.height);
  ctx.fillStyle = "#0b1226";
  ctx.fillRect(0,0,pipCanvas.width,pipCanvas.height);

  const { now, current, next } = computeCurrentAndNext();
  ctx.fillStyle = "#fff";
  ctx.textAlign = "center";

  if (current) {
    const endDate = timeToDateToday(current.entry.end);
    const timeLeft = msToMinSec(endDate - now);

    ctx.font = "bold 36px system-ui, sans-serif";
    ctx.fillText(timeLeft, pipCanvas.width / 2, 60);

    ctx.font = "18px system-ui, sans-serif";
    ctx.fillText(current.entry.name, pipCanvas.width / 2, 95);

    ctx.font = "14px system-ui, sans-serif";
    ctx.fillText(
      next
        ? `Next: ${next.entry.name} at ${next.entry.start}`
        : "No more periods today",
      pipCanvas.width / 2,
      125
    );

  } else if (next) {
    const startDate = timeToDateToday(next.entry.start);
    const timeUntil = msToMinSec(startDate - now);

    ctx.font = "bold 32px system-ui, sans-serif";
    ctx.fillText(timeUntil, pipCanvas.width / 2, 60);

    ctx.font = "18px system-ui, sans-serif";
    ctx.fillText(`Next: ${next.entry.name}`, pipCanvas.width / 2, 95);

    ctx.font = "14px system-ui, sans-serif";
    ctx.fillText(`Starts at ${next.entry.start}`, pipCanvas.width / 2, 125);

  } else {
    ctx.font = "bold 22px system-ui, sans-serif";
    ctx.fillText("No periods left.", pipCanvas.width / 2, 75);

    ctx.font = "14px system-ui, sans-serif";
    ctx.fillText("Enjoy your free time!", pipCanvas.width / 2, 105);
  }
}





function wait(ms){ return new Promise(res=>setTimeout(res, ms)); }
async function enablePiP(){
  if(!document.pictureInPictureEnabled){ showToast("PiP unsupported"); return; }
  if(!pipStreamAttached){ const stream = pipCanvas.captureStream(25); pipVideo.srcObject = stream; pipStreamAttached = true; }
  if(pipDrawingInterval) clearInterval(pipDrawingInterval);
  drawPiPTimer(); pipDrawingInterval = setInterval(drawPiPTimer, 500);
  try{
    await pipVideo.play().catch(async ()=>{ await wait(100); return pipVideo.play().catch(()=>{}); });
    await wait(120); await pipVideo.requestPictureInPicture(); floatingBtn.innerText="Exit Floating"; showToast("Floating enabled");
  }catch(e){ console.warn("PiP err", e); showToast("Could not open floating window"); if(pipDrawingInterval){ clearInterval(pipDrawingInterval); pipDrawingInterval=null; } }
}
async function disablePiP(){ try{ if(document.pictureInPictureElement) await document.exitPictureInPicture(); }catch(e){} if(pipDrawingInterval){ clearInterval(pipDrawingInterval); pipDrawingInterval=null; } floatingBtn.innerText="Floating Mode"; showToast("Floating stopped"); }
floatingBtn.addEventListener("click", async ()=>{ if(document.pictureInPictureElement){ await disablePiP(); return; } await enablePiP(); });
document.addEventListener('leavepictureinpicture', ()=>{ if(pipDrawingInterval){ clearInterval(pipDrawingInterval); pipDrawingInterval=null; } floatingBtn.innerText="Floating Mode"; });

/* Initialization */
function init(){
  viewWeekSelect.value = getActiveWeek();
  document.getElementById("activeWeekLabel").innerText = " " + getActiveWeek();
  weeksEl.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=true);
  renderScheduleList();
  renderScheduleSummary();
  updatePopup();
  setInterval(updatePopup, 1000);
  setInterval(()=>{ if(Notification && Notification.permission === "granted" && notifEnabled) scheduleNotificationsForNextEvents(); }, 60*1000);
}
init();

</script>
</body>
</html>
